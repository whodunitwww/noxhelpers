return function(a)local b,c,d,e,f,g=a.Services,a.Tabs,a.References,a.Library,a.Options,a.Toggles;local h,i,j=a.MoveToPos,a.PREFIX or"NH_",a.Config or{}local k=j.DodgeConfig or{}local l=j.AutoYOffsetConfig or{}local m=j.TargetTypes or{Players={key="Players"},Entities={key="Entities"}}local n=j.Defaults or{mode="Aligned",yOffset=10,horizDist=4,targetType="Players"}local o=j.UIText or{groupTitle="Attach",statusTitle="Autofarm Status"}local p=j.Move or{approachMaxSecs=12,reachDistance=3,moveForceResp=80,moveMaxVelocity=120,orientResp=120}local q=j.Perf or{scanCooldown=0.5,waitScanHz=4,statusHz=5}local r=j.Loot or{Names={}}local s={mode=n.mode,yOffset=n.yOffset,horizDist=n.horizDist,targetType=n.targetType,selectedTargets={},currentInst=nil,attached=false,_phase="Idle",_hb=nil,_watchSelf=nil,_moveCleanup=nil,dodgeMode=n.dodgeMode,autoYOffset=n.autoYOffset,_dodgeActive=false,_dodgeConns={},_dodgeScanHB=nil,_dodgeRange=50,showStatus=n.showStatus,_statusHB=nil,_statusDiedConn=nil,_statusLastTarget=nil,_statusLastHealth=nil,_statusGui=nil,_statusBar=nil,_statusText=nil,_hoverAP=nil,_hoverAO=nil,_hoverA0=nil,_hoverA1=nil,_hoverNoclipHB=nil,_instToLabel={},_labelToList={}}local function t(u)if not(u and u.Parent)then return false end;local v=u:FindFirstChildOfClass("Humanoid")if v then return v.Health>0 end;if u:IsA("Player")then local w=u.Character;local x=w and w:FindFirstChildOfClass("Humanoid")return w and x and x.Health>0 or false end;return(u:FindFirstChild("HumanoidRootPart")or u:FindFirstChildWhichIsA("BasePart"))~=nil end;local function y(z)if not z then return end;if z:IsA("Player")then local w=z.Character;return w and w:FindFirstChild("HumanoidRootPart")end;return z:FindFirstChild("HumanoidRootPart")or z:FindFirstChildWhichIsA("BasePart")end;local function A(z)if not z then return end;if z:IsA("Player")then local w=z.Character;return w and w:FindFirstChildOfClass("Humanoid")end;if z:IsA("Model")then return z:FindFirstChildOfClass("Humanoid")end end;local function B(u)if not u then return"nil"end;if u:IsA("Player")then return u.DisplayName~=""and u.DisplayName or u.Name end;return u.Name end;local function C(D,E,F,G)local H,I=D.LookVector,D.RightVector;local J=Vector3.new(0,G,0)if E=="Behind"then return-H*F+J elseif E=="In Front"then return H*F+J elseif E=="Left"then return-I*F+J elseif E=="Right"then return I*F+J else return J end end;local function K(L)local M={}for N in string.gmatch(L or"","[^/]+")do M[#M+1]=N end;return M end;local function O(P,L)if not P then return nil end;local M=K(L)if#M==0 then return nil end;local Q=P;if M[1]=="Workspace"then table.remove(M,1)end;for R,N in ipairs(M)do Q=Q:FindFirstChild(N)if not Q then return nil end end;return Q end;local function S(T,U)if not U then return true end;T=tostring(T or"")local V=U.caseInsensitive;if U.names then for R,W in ipairs(U.names)do if V then if string.lower(T)==string.lower(W)then return true end else if T==W then return true end end end;return false end;if U.patterns then for R,X in ipairs(U.patterns)do local Y,Z=pcall(string.find,V and string.lower(T)or T,V and string.lower(X)or X)if Y and Z then return true end end;return false end;return true end;local function _(a0,U)if not U then return a0 end;local a1={}for W,a2 in pairs(a0)do local a3=true;if U.include then a3=U.include[W]==true end;if U.exclude and U.exclude[W]then a3=false end;if a3 then a1[W]=a2 end end;return a1 end;local function a4(a0,a5,u)a0[a5]=a0[a5]or{}table.insert(a0[a5],u)end;local function a6()local Z={}for R,L in ipairs(b.Players:GetPlayers())do if L~=d.player then Z[L.DisplayName~=""and L.DisplayName or L.Name]={L}end end;return Z end;local function a7()local Z={}for R,a8 in ipairs(b.Workspace:GetDescendants())do if a8:IsA("Model")and not b.Players:GetPlayerFromCharacter(a8)then local v=a8:FindFirstChildOfClass("Humanoid")if v then a4(Z,a8.Name,a8)end end end;return Z end;local function a9(aa,ab)ab=ab or{}local P=O(b.Workspace,aa)local Z={}if not P then return Z end;for R,a8 in ipairs(P:GetDescendants())do if ab.modelsOnly and a8:IsA("Model")then if not ab.humanoidsOnly or a8:FindFirstChildOfClass("Humanoid")then if S(a8.Name,ab)and(not ab.filter or ab.filter(a8))then a4(Z,a8.Name,a8)end end elseif not ab.modelsOnly then if S(a8.Name,ab)and(not ab.filter or ab.filter(a8))then a4(Z,a8.Name,a8)end end end;return Z end;local ac={}local ad=tonumber(q.scanCooldown)or 0.5;local function ae(a5)local af=os.clock()local ag=ac[a5]if ag and af-ag.t<ad then return ag.res end;return nil end;local function ah(a5,Z)ac[a5]={t=os.clock(),res=Z}end;local function ai(aj,U)local ak=ae(aj)if ak then return ak end;local Z={}if U.getItems then local Y,a0=pcall(U.getItems,b,d)Z=Y and(a0 or{})or{}elseif U.folderPath then Z=a9(U.folderPath,U)elseif U.key=="Players"then Z=a6()elseif U.key=="Entities"then local al=a7()if U.names or U.patterns then local am={}for W,a2 in pairs(al)do if S(W,U)then am[W]=a2 end end;Z=am else Z=al end else Z={}end;Z=_(Z,U)s._labelToList=Z;s._instToLabel={}for an,a2 in pairs(Z)do for R,u in ipairs(a2)do s._instToLabel[u]=an end end;ah(aj,Z)return Z end;local function ao(aj)local U=m[aj]if not U then return{}end;return ai(aj,U)end;local function ap(aq)local ar;for R,L in ipairs(b.Players:GetPlayers())do if L~=d.player then local w=L.Character;local as=w and w:FindFirstChild("HumanoidRootPart")if as then local a8=(as.Position-aq).Magnitude;if not ar or a8<ar then ar=a8 end end end end;return ar or math.huge end;local function at(u)if not(g.ATT_Safety and g.ATT_Safety.Value)then return true end;local au=y(u)if not au then return false end;local av=f.ATT_SafetyRange and f.ATT_SafetyRange.Value or 50;return ap(au.Position)>av end;local function aw()local a0=ao(s.targetType)local ax={}for R,T in ipairs(s.selectedTargets or{})do local a2=a0[T]if a2 then for R,u in ipairs(a2)do if t(u)and at(u)then ax[#ax+1]=u end end end end;return ax end;local function ay(a2)local as=d.humanoidRootPart;if not as or not a2 or#a2==0 then return end;local ar,az;for R,u in ipairs(a2)do local aA=y(u)if aA then local a8=(aA.Position-as.Position).Magnitude;if not az or a8<az then ar,az=u,a8 end end end;return ar end;local function aB()if not(g.ATT_CollectLoot and g.ATT_CollectLoot.Value)then return{}end;local as=d.humanoidRootPart;if not as then return{}end;local aC=r.Names or{}local aD=f.ATT_LootRange and f.ATT_LootRange.Value or 150;local a2={}for R,aE in ipairs(b.Workspace:GetChildren())do if aE:IsA("MeshPart")and aC[aE.Name]then local au=aE;local aF=(au.Position-as.Position).Magnitude;if aF<=aD then if at(aE)then a2[#a2+1]=aE end end end end;return a2 end;local function aG()local aH=aB()if#aH>0 then return ay(aH)end;return ay(aw())end;local function aI()for R,ag in ipairs(s._dodgeConns)do pcall(function()ag:Disconnect()end)end;s._dodgeConns={}if s._dodgeScanHB then pcall(function()s._dodgeScanHB:Disconnect()end)end;s._dodgeScanHB=nil;s._dodgeActive=false end;local function aJ(aK,aL)if s._dodgeActive then return end;s._dodgeActive=true;local aM=s.yOffset;s.yOffset=aK;task.delay(aL,function()if s._dodgeActive then s.yOffset=aM;s._dodgeActive=false end end)end;local function aN(u)local as=d.humanoidRootPart;local aA=y(u)if not(as and aA)then return false end;local I=s._dodgeRange or 50;return(aA.Position-as.Position).Magnitude<=I end;local function aO()aI()if not s.dodgeMode then return end;s._dodgeScanHB=b.RunService.Heartbeat:Connect(function()if math.random()<0.85 then return end;for R,a8 in ipairs(b.Workspace:GetDescendants())do if a8:IsA("Model")and not b.Players:GetPlayerFromCharacter(a8)then local v=a8:FindFirstChildOfClass("Humanoid")if v and aN(a8)then if not v:GetAttribute(i.."DodgeBound")then v:SetAttribute(i.."DodgeBound",true)local aP=v.AnimationPlayed:Connect(function(aQ)local aR=tonumber((aQ.Animation.AnimationId or""):match("%d+"))local aS=aR and k[aR]if aS then task.delay(aS.delay,function()aJ(aS.dodgeY,aS.duration)end)end end)table.insert(s._dodgeConns,aP)end end end end end)end;local function aT(z)if s._dodgeActive then return end;if not(s.autoYOffset and z)then return end;local an=s._instToLabel[z]if not an then return end;for a5,aU in pairs(l)do if tostring(an):find(a5)then s.yOffset=aU;return end end end;local function aV()if s._hb then pcall(function()s._hb:Disconnect()end)s._hb=nil end;if s._moveCleanup then pcall(s._moveCleanup)s._moveCleanup=nil end;s._phase="Idle"end;local function aW()if s._moveCleanup then pcall(s._moveCleanup)s._moveCleanup=nil end end;local function aX()if s._statusGui then pcall(function()s._statusGui:Destroy()end)end;s._statusGui,s._statusBar,s._statusText=nil,nil,nil end;local function aY()if s._statusGui and s._statusGui.Parent then return end;local aZ=b.Players.LocalPlayer:FindFirstChildOfClass("PlayerGui")if not aZ then return end;local a_=Instance.new("ScreenGui")a_.Name=i.."AttachStatus"a_.ResetOnSpawn=false;a_.ZIndexBehavior=Enum.ZIndexBehavior.Sibling;a_.Parent=aZ;local b0=Instance.new("Frame")b0.Name="Panel"b0.AnchorPoint=Vector2.new(0,0)b0.Position=UDim2.fromOffset(12,100)b0.Size=UDim2.fromOffset(240,62)b0.BackgroundColor3=Color3.fromRGB(18,18,18)b0.BackgroundTransparency=0.2;b0.BorderSizePixel=0;b0.Parent=a_;local b1=Instance.new("UICorner")b1.CornerRadius=UDim.new(0,10)b1.Parent=b0;local b2=Instance.new("TextLabel")b2.Name="Title"b2.Size=UDim2.new(1,-10,0,22)b2.Position=UDim2.fromOffset(8,6)b2.BackgroundTransparency=1;b2.Font=Enum.Font.GothamSemibold;b2.TextSize=14;b2.TextXAlignment=Enum.TextXAlignment.Left;b2.TextColor3=Color3.fromRGB(200,255,200)b2.Text=o.statusTitle or"Autofarm Status"b2.Parent=b0;local b3=Instance.new("TextLabel")b3.Name="HPText"b3.Size=UDim2.new(1,-10,0,18)b3.Position=UDim2.fromOffset(8,28)b3.BackgroundTransparency=1;b3.Font=Enum.Font.Gotham;b3.TextSize=13;b3.TextXAlignment=Enum.TextXAlignment.Left;b3.TextColor3=Color3.fromRGB(230,230,230)b3.Text="Target: —  HP: —/—"b3.Parent=b0;local b4=Instance.new("Frame")b4.Name="BarBG"b4.Size=UDim2.fromOffset(224,8)b4.Position=UDim2.fromOffset(8,48)b4.BackgroundColor3=Color3.fromRGB(45,45,45)b4.BorderSizePixel=0;b4.Parent=b0;local b5=Instance.new("UICorner")b5.CornerRadius=UDim.new(0,4)b5.Parent=b4;local b6=Instance.new("Frame")b6.Name="Bar"b6.Size=UDim2.new(0,0,1,0)b6.BackgroundColor3=Color3.fromRGB(50,205,50)b6.BorderSizePixel=0;b6.Parent=b4;local b7=Instance.new("UICorner")b7.CornerRadius=UDim.new(0,4)b7.Parent=b6;s._statusGui,s._statusBar,s._statusText=a_,b6,b3 end;local function b8(z,b9,ba)if not(s._statusGui and s._statusGui.Parent)then return end;local aA,bb=s._statusText,s._statusBar;if not(aA and bb)then return end;local x,bc=tonumber(b9)or 0,tonumber(ba)or 0;local bd=bc>0 and math.clamp(x/bc,0,1)or 0;aA.Text=("Target: %s    HP: %d/%d"):format(z and B(z)or"—",x,bc)bb.Size=UDim2.new(bd,0,1,0)end;local function be()if s._statusHB then pcall(function()s._statusHB:Disconnect()end)s._statusHB=nil end;if s._statusDiedConn then pcall(function()s._statusDiedConn:Disconnect()end)s._statusDiedConn=nil end;s._statusLastTarget,s._statusLastHealth=nil,nil;aX()end;local function bf(z)if s._statusDiedConn then pcall(function()s._statusDiedConn:Disconnect()end)s._statusDiedConn=nil end;local v=A(z)if v then s._statusDiedConn=v.Died:Connect(function()local bg=B(z)local bh=aG()if bh and bh~=z then s.currentInst=bh;if s._phase~="Approach"and s.attached then startApproach()end end end)end end;local function bi()be()if not s.showStatus then return end;aY()local bj,bk=0,1/math.max(1,tonumber(q.statusHz)or 5)s._statusHB=b.RunService.Heartbeat:Connect(function(bl)if not s.showStatus then return end;bj=bj+bl;if bj<bk then return end;bj=0;local bm=s.currentInst;if bm~=s._statusLastTarget then s._statusLastTarget,s._statusLastHealth=bm,nil;if bm then bf(bm)end end;if not bm then b8(nil,0,0)return end;local v=A(bm)if v then local b9,bc=math.floor(v.Health),math.floor(v.MaxHealth or 0)if b9~=s._statusLastHealth then s._statusLastHealth=b9;b8(bm,b9,bc)end else b8(bm,0,0)end end)end;local function bn()aV()s._phase="Waiting"local bj,bk=0,1/math.max(1,tonumber(q.waitScanHz)or 4)s._hb=b.RunService.Heartbeat:Connect(function(bl)if not s.attached then return end;bj=bj+bl;if bj<bk then return end;bj=0;local bh=aG()if bh then s.currentInst=bh;startApproach()end end)end;function startApproach()aV()s._phase="Approach"local bm=s.currentInst;if not bm then local bo=aG()if not bo then bn()return end;bm=bo;s.currentInst=bo end;aT(bm)if s.showStatus then bi()end;aO()local function bp()if not t(bm)then return true end;if not at(bm)then return true end;return false end;local function bq()if bp()then return nil end;local aA=y(bm)if not aA then return nil end;return aA.Position+C(aA.CFrame,s.mode,s.horizDist,s.yOffset)end;local br=bq()if not br then bn()return end;s._moveCleanup=h(br,1000,bq)local bs=os.clock()s._hb=b.RunService.Heartbeat:Connect(function()if s._phase~="Approach"then return end;local bt=d.humanoidRootPart;if not bt then aV()return end;local bu=bq()if not bu then local bh=aG()if bh then s.currentInst=bh;startApproach()else bn()end;return end;if(bt.Position-bu).Magnitude<=(p.reachDistance or 3)then aW()s._phase="Hover"task.defer(function()if s.attached then task.wait(0.05)startHover()end end)return end;if os.clock()-bs>(p.approachMaxSecs or 12)then bn()return end;if not t(bm)or not at(bm)then local bh=aG()if bh then s.currentInst,bm=bh,bh;aT(bm)local bv=bq()if bv then aW()s._moveCleanup=h(bv,1000,bq)bs=os.clock()else bn()end else bn()end end end)end;local function bw()for R,bx in ipairs({s._hoverAP,s._hoverAO,s._hoverA0,s._hoverA1})do if bx then pcall(function()bx:Destroy()end)end end;s._hoverAP,s._hoverAO,s._hoverA0,s._hoverA1=nil,nil,nil,nil;if s._hoverNoclipHB then pcall(function()s._hoverNoclipHB:Disconnect()end)end;s._hoverNoclipHB=nil end;local function by()local bz=d.character;if not bz then return end;for R,a8 in ipairs(bz:GetDescendants())do if a8:IsA("BasePart")then a8.CanCollide=false end end end;function startHover()if s._hb then pcall(function()s._hb:Disconnect()end)s._hb=nil end;bw()s._phase="Hover"local bt,bm,bA=d.humanoidRootPart,s.currentInst,nil;bA=y(bm)if not(bt and bA and t(bm)and at(bm))then bn()return end;if d.humanoid then d.humanoid.AutoRotate=false end;bt.AssemblyAngularVelocity=Vector3.zero;local bB=Instance.new("Attachment")bB.Name=i.."HoverA0"bB.Parent=bt;local bC=Instance.new("Attachment")bC.Name=i.."HoverA1"bC.Parent=bA;local bD=Instance.new("AlignPosition")bD.Name=i.."HoverAP"bD.Mode=Enum.PositionAlignmentMode.TwoAttachment;bD.Attachment0=bB;bD.Attachment1=bC;bD.Responsiveness=p.moveForceResp or 80;bD.MaxVelocity=p.moveMaxVelocity or 120;bD.MaxForce=math.huge;bD.Parent=bt;local bE=Instance.new("AlignOrientation")bE.Name=i.."HoverAO"bE.Attachment0=bB;bE.Responsiveness=p.orientResp or 120;bE.MaxTorque=math.huge;bE.RigidityEnabled=true;bE.Parent=bt;s._hoverAP,s._hoverAO,s._hoverA0,s._hoverA1=bD,bE,bB,bC;local function bF()local bG=y(s.currentInst)if not bG then return end;if not s._dodgeActive then aT(s.currentInst)end;local D=bG.CFrame;local bH=C(D,s.mode,s.horizDist,s.yOffset)bC.Position=D:VectorToObjectSpace(bH)end;local function bI()local bJ,bK,bG=s.currentInst,d.humanoidRootPart,y(s.currentInst)if not(bJ and t(bJ)and bK and bG and at(bJ))then bn()return end;local bL,bM=bK.Position,bG.Position;local bN=bM-bL;if bN.Magnitude<1e-6 then return end;bN=bN.Unit;local J=math.abs(bN:Dot(Vector3.yAxis))>0.98 and Vector3.xAxis or Vector3.yAxis;local bO=CFrame.lookAt(bL,bM,J)*CFrame.Angles(0,math.pi,0)s._hoverAO.CFrame=bO end;bF()bI()by()s._hoverNoclipHB=b.RunService.Stepped:Connect(by)s._hb=b.RunService.RenderStepped:Connect(function()if not s.attached then return end;bF()bI()if not at(s.currentInst)then local bh=aG()if bh and bh~=s.currentInst then s.currentInst=bh;startApproach()else bn()end end end)end;local function bP()if s._hb then pcall(function()s._hb:Disconnect()end)s._hb=nil end;bw()if d.humanoid then d.humanoid.AutoRotate=true end;s._phase="Idle"end;local function bQ()bP()aV()be()aI()if s.attached then task.wait(0.25)s.currentInst=nil;bn()end end;local function bR()if s._watchSelf then s._watchSelf:Disconnect()s._watchSelf=nil end end;local function bS()bR()s._watchSelf=b.Players.LocalPlayer.CharacterAdded:Connect(function()task.wait(0.35)bQ()end)end;local bT=c.Main:AddRightGroupbox(o.groupTitle or"Attach","link")local bU,bV;local function bW(bX)local a0=ao(s.targetType)local aC={}for W,bY in pairs(a0)do if bY and#bY>0 then aC[#aC+1]=W end end;table.sort(aC)bX:SetValues(aC)end;do local bZ={}for b_,R in pairs(m)do bZ[#bZ+1]=b_ end;table.sort(bZ)bV=bT:AddDropdown("ATT_Type",{Text="Target Type",Values=bZ,Default=n.targetType or bZ[1],Callback=function(bx)s.targetType=bx;s.selectedTargets={}bW(bU)end})end;bU=bT:AddDropdown("ATT_Target",{Text="Target",Values={},Multi=true,Callback=function(bx)local ax={}for T,c0 in pairs(bx)do if c0 then ax[#ax+1]=T end end;s.selectedTargets=ax;if s.attached then local bh=aG()if bh then s.currentInst=bh;startApproach()else bn()end end end})bT:AddButton({Text="Refresh Targets",Func=function()bW(bU)end})bT:AddDropdown("ATT_Mode",{Text="Attach Mode",Values={"Behind","In Front","Left","Right","Aligned"},Default=n.mode or"Behind",Callback=function(bx)s.mode=bx;if s.attached then startApproach()end end})bT:AddSlider("ATT_Y",{Text="Y Offset",Default=n.yOffset or 10,Min=-30,Max=30,Suffix=" studs",Callback=function(bx)s.yOffset=bx;if s.attached then startApproach()end end})bT:AddToggle("ATT_On",{Text="Attach",Default=false,Callback=function(c0)s.attached=c0;if c0 then bS()aO()local aA=aG()s.currentInst=aA;if not aA then bn()return end;startApproach()if s.showStatus then bi()end else bP()bR()be()aI()end end})bT:AddToggle("ATT_Dodge",{Text="Dodge Mode",Default=n.dodgeMode or false,Callback=function(bx)s.dodgeMode=bx;if bx then aO()else aI()end end})bT:AddSlider("ATT_DodgeRange",{Text="Dodge Range",Default=50,Min=10,Max=200,Suffix=" studs",Callback=function(bx)s._dodgeRange=bx end})bT:AddToggle("ATT_AutoY",{Text="AutoSet Y Offset",Default=n.autoYOffset or false,Callback=function(bx)s.autoYOffset=bx end})bT:AddToggle("ATT_Status",{Text="Show Status",Default=n.showStatus or false,Tooltip="On-screen target + HP HUD.",Callback=function(c0)s.showStatus=c0;if c0 then bi()else be()end end})bT:AddToggle("ATT_Safety",{Text="Safety Mode",Default=false,Tooltip="Will ignore targets close to other players."})bT:AddSlider("ATT_SafetyRange",{Text="Safety Range",Default=50,Min=10,Max=200,Suffix=" studs"})bT:AddToggle("ATT_CollectLoot",{Text="Collect Loot",Default=false,Tooltip="Override targets if loot is nearby."})bT:AddSlider("ATT_LootRange",{Text="Loot Range",Default=150,Min=25,Max=1000,Suffix=" studs"})bW(bU)local c1={}function c1.Unload()bP()aV()be()aI()bR()if g and g.ATT_On and g.ATT_On.Value then pcall(function()g.ATT_On:SetValue(false)end)end end;return c1 end
