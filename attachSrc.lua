return function(a)local b,c,d,e,f,g=a.Services,a.Tabs,a.References,a.Library,a.Options,a.Toggles;local h,i,j=a.MoveToPos,a.PREFIX or"NH_",a.Config or{}local k=j.DodgeConfig or{}local l=j.AutoYOffsetConfig or{}local m=j.TargetTypes or{Players={key="Players"},Entities={key="Entities"}}local n=j.Defaults or{mode="Aligned",yOffset=10,horizDist=4,targetType="Players"}local o=j.UIText or{groupTitle="Attach",statusTitle="Autofarm Status"}local p=j.Move or{approachMaxSecs=12,reachDistance=3,moveForceResp=80,moveMaxVelocity=120,orientResp=120}local q=j.Perf or{scanCooldown=0.5,waitScanHz=4,statusHz=5}local r={mode=n.mode,yOffset=n.yOffset,horizDist=n.horizDist,targetType=n.targetType,selectedTargets={},currentInst=nil,attached=false,_phase="Idle",_hb=nil,_watchSelf=nil,_moveCleanup=nil,dodgeMode=n.dodgeMode,autoYOffset=n.autoYOffset,_dodgeActive=false,_dodgeConn=nil,showStatus=n.showStatus,_statusHB=nil,_statusDiedConn=nil,_statusLastTarget=nil,_statusLastHealth=nil,_statusGui=nil,_statusBar=nil,_statusText=nil,_hoverAP=nil,_hoverAO=nil,_hoverA0=nil,_hoverA1=nil}local function s(t)if not(t and t.Parent)then return false end;local u=t:FindFirstChildOfClass("Humanoid")if u then return u.Health>0 end;if t:IsA("Player")then local v=t.Character;local w=v and v:FindFirstChildOfClass("Humanoid")return v and w and w.Health>0 or false end;return(t:FindFirstChild("HumanoidRootPart")or t:FindFirstChildWhichIsA("BasePart"))~=nil end;local function x(y)if not y then return end;if y:IsA("Player")then local v=y.Character;return v and v:FindFirstChild("HumanoidRootPart")end;return y:FindFirstChild("HumanoidRootPart")or y:FindFirstChildWhichIsA("BasePart")end;local function z(y)if not y then return end;if y:IsA("Player")then local v=y.Character;return v and v:FindFirstChildOfClass("Humanoid")end;if y:IsA("Model")then return y:FindFirstChildOfClass("Humanoid")end end;local function A(t)if not t then return"nil"end;if t:IsA("Player")then return t.DisplayName~=""and t.DisplayName or t.Name end;return t.Name end;local function B(C,D,E,F)local G,H=C.LookVector,C.RightVector;local I=Vector3.new(0,F,0)if D=="Behind"then return-G*E+I elseif D=="In Front"then return G*E+I elseif D=="Left"then return-H*E+I elseif D=="Right"then return H*E+I else return I end end;local J={Players={t=0,res=nil},Entities={t=0,res=nil}}local K=tonumber(q.scanCooldown)or 0.5;local function L()local M={}for N,O in ipairs(b.Players:GetPlayers())do if O~=d.player then M[O.DisplayName~=""and O.DisplayName or O.Name]={O}end end;return M end;local function P()local M={}for N,Q in ipairs(b.Workspace:GetDescendants())do if Q:IsA("Model")and not b.Players:GetPlayerFromCharacter(Q)then local u=Q:FindFirstChildOfClass("Humanoid")if u then M[Q.Name]=M[Q.Name]or{}table.insert(M[Q.Name],Q)end end end;return M end;local function R(S)local T=os.clock()if S=="Players"then local U=J.Players;if T-U.t>=K or not U.res then U.res=L()U.t=T end;return U.res elseif S=="Entities"then local U=J.Entities;if T-U.t>=K or not U.res then U.res=P()U.t=T end;return U.res end;return{}end;local function V(W)local X=m[W]if not X then return{}end;return R(X.key or W)end;local function Y()local Z=V(r.targetType)local _={}for N,a0 in ipairs(r.selectedTargets or{})do local a1=Z[a0]if a1 then for N,t in ipairs(a1)do if s(t)then _[#_+1]=t end end end end;return _ end;local function a2(a1)local a3=d.humanoidRootPart;if not a3 or not a1 or#a1==0 then return end;local a4,a5;for N,t in ipairs(a1)do local a6=x(t)if a6 then local Q=(a6.Position-a3.Position).Magnitude;if not a5 or Q<a5 then a4,a5=t,Q end end end;return a4 end;local function a7()return a2(Y())end;local function a8()if r._dodgeActive then r._dodgeActive=false end end;local function a9(aa,ab)if r._dodgeActive then return end;r._dodgeActive=true;local ac=r.yOffset;r.yOffset=aa;task.delay(ab,function()if r._dodgeActive then r.yOffset=ac;a8()end end)end;local function ad(y)if r._dodgeConn then r._dodgeConn:Disconnect()end;if not(r.dodgeMode and y)then return end;local u=y:FindFirstChildOfClass("Humanoid")if not u then return end;r._dodgeConn=u.AnimationPlayed:Connect(function(ae)local af=tonumber((ae.Animation.AnimationId or""):match("%d+"))local ag=af and k[af]if ag then task.delay(ag.delay,function()a9(ag.dodgeY,ag.duration)end)end end)end;local function ah(y)if r._dodgeActive then return end;if not(r.autoYOffset and y)then return end;for a0,ai in pairs(l)do if y.Name:find(a0)then r.yOffset=ai;return end end end;local function aj()if r._hb then pcall(function()r._hb:Disconnect()end)r._hb=nil end;if r._moveCleanup then pcall(r._moveCleanup)r._moveCleanup=nil end;r._phase="Idle"end;local function ak()if r._moveCleanup then pcall(r._moveCleanup)r._moveCleanup=nil end end;local function al()if r._statusGui then pcall(function()r._statusGui:Destroy()end)end;r._statusGui,r._statusBar,r._statusText=nil,nil,nil end;local function am()if r._statusGui and r._statusGui.Parent then return end;local an=b.Players.LocalPlayer:FindFirstChildOfClass("PlayerGui")if not an then return end;local ao=Instance.new("ScreenGui")ao.Name=i.."AttachStatus"ao.ResetOnSpawn=false;ao.ZIndexBehavior=Enum.ZIndexBehavior.Sibling;ao.Parent=an;local ap=Instance.new("Frame")ap.Name="Panel"ap.AnchorPoint=Vector2.new(0,0)ap.Position=UDim2.fromOffset(12,100)ap.Size=UDim2.fromOffset(240,62)ap.BackgroundColor3=Color3.fromRGB(18,18,18)ap.BackgroundTransparency=0.2;ap.BorderSizePixel=0;ap.Parent=ao;local aq=Instance.new("UICorner")aq.CornerRadius=UDim.new(0,10)aq.Parent=ap;local ar=Instance.new("TextLabel")ar.Name="Title"ar.Size=UDim2.new(1,-10,0,22)ar.Position=UDim2.fromOffset(8,6)ar.BackgroundTransparency=1;ar.Font=Enum.Font.GothamSemibold;ar.TextSize=14;ar.TextXAlignment=Enum.TextXAlignment.Left;ar.TextColor3=Color3.fromRGB(200,255,200)ar.Text=o.statusTitle or"Autofarm Status"ar.Parent=ap;local as=Instance.new("TextLabel")as.Name="HPText"as.Size=UDim2.new(1,-10,0,18)as.Position=UDim2.fromOffset(8,28)as.BackgroundTransparency=1;as.Font=Enum.Font.Gotham;as.TextSize=13;as.TextXAlignment=Enum.TextXAlignment.Left;as.TextColor3=Color3.fromRGB(230,230,230)as.Text="Target: —  HP: —/—"as.Parent=ap;local at=Instance.new("Frame")at.Name="BarBG"at.Size=UDim2.fromOffset(224,8)at.Position=UDim2.fromOffset(8,48)at.BackgroundColor3=Color3.fromRGB(45,45,45)at.BorderSizePixel=0;at.Parent=ap;local au=Instance.new("UICorner")au.CornerRadius=UDim.new(0,4)au.Parent=at;local av=Instance.new("Frame")av.Name="Bar"av.Size=UDim2.new(0,0,1,0)av.BackgroundColor3=Color3.fromRGB(50,205,50)av.BorderSizePixel=0;av.Parent=at;local aw=Instance.new("UICorner")aw.CornerRadius=UDim.new(0,4)aw.Parent=av;r._statusGui,r._statusBar,r._statusText=ao,av,as end;local function ax(y,ay,az)if not(r._statusGui and r._statusGui.Parent)then return end;local a6,aA=r._statusText,r._statusBar;if not(a6 and aA)then return end;local w,aB=tonumber(ay)or 0,tonumber(az)or 0;local aC=aB>0 and math.clamp(w/aB,0,1)or 0;a6.Text=("Target: %s    HP: %d/%d"):format(y and A(y)or"—",w,aB)aA.Size=UDim2.new(aC,0,1,0)end;local function aD()if r._statusHB then pcall(function()r._statusHB:Disconnect()end)r._statusHB=nil end;if r._statusDiedConn then pcall(function()r._statusDiedConn:Disconnect()end)r._statusDiedConn=nil end;r._statusLastTarget,r._statusLastHealth=nil,nil;al()end;local function aE(y)if r._statusDiedConn then pcall(function()r._statusDiedConn:Disconnect()end)r._statusDiedConn=nil end;local u=z(y)if u then r._statusDiedConn=u.Died:Connect(function()local aF=A(y)local aG=a7()if aG and aG~=y then r.currentInst=aG;print(("[ATTACH][Status] %s died. New target → %s"):format(aF,A(aG)))if r._phase~="Approach"and r.attached then startApproach()end else print(("[ATTACH][Status] %s died. No new target available."):format(aF))end end)end end;local function aH()aD()if not r.showStatus then return end;am()local aI,aJ=0,1/math.max(1,tonumber(q.statusHz)or 5)r._statusHB=b.RunService.Heartbeat:Connect(function(aK)if not r.showStatus then return end;aI=aI+aK;if aI<aJ then return end;aI=0;local aL=r.currentInst;if aL~=r._statusLastTarget then if r._statusLastTarget and aL then print(("[ATTACH][Status] Target switch: %s → %s"):format(A(r._statusLastTarget),A(aL)))end;r._statusLastTarget,r._statusLastHealth=aL,nil;if aL then aE(aL)end end;if not aL then ax(nil,0,0)return end;local u=z(aL)if u then local ay,aB=math.floor(u.Health),math.floor(u.MaxHealth or 0)if ay~=r._statusLastHealth then r._statusLastHealth=ay;ax(aL,ay,aB)end else ax(aL,0,0)end end)end;local function aM()aj()r._phase="Waiting"local aI,aJ=0,1/math.max(1,tonumber(q.waitScanHz)or 4)r._hb=b.RunService.Heartbeat:Connect(function(aK)if not r.attached then return end;if not(r.selectedTargets and#r.selectedTargets>0)then return end;aI=aI+aK;if aI<aJ then return end;aI=0;local aG=a7()if aG then r.currentInst=aG;startApproach()end end)end;function startApproach()aj()r._phase="Approach"local aL=r.currentInst;if not aL then local aN=a7()if not aN then aM()return end;aL=aN;r.currentInst=aN end;ah(aL)ad(aL)if r.showStatus then aH()end;local function aO()if not s(aL)then return nil end;local a6=x(aL)if not a6 then return nil end;return a6.Position+B(a6.CFrame,r.mode,r.horizDist,r.yOffset)end;local aP=aO()if not aP then aM()return end;r._moveCleanup=h(aP,1000,aO)local aQ=os.clock()r._hb=b.RunService.Heartbeat:Connect(function()if r._phase~="Approach"then return end;local aR=d.humanoidRootPart;if not aR then aj()return end;local aS=aO()if not aS then aM()return end;if(aR.Position-aS).Magnitude<=(p.reachDistance or 3)then ak()r._phase="Hover"task.defer(function()if r.attached then task.wait(0.05)startHover()end end)return end;if os.clock()-aQ>(p.approachMaxSecs or 12)then aM()return end;if not s(aL)then local aG=a7()if aG then local aT=aL;r.currentInst,aL=aG,aG;print(("[ATTACH][Status] %s died. New target → %s"):format(A(aT),A(aG)))if r.showStatus then aH()end;ah(aL)ad(aL)local aU=aO()if aU then ak()r._moveCleanup=h(aU,1000,aO)aQ=os.clock()else aM()end else print(("[ATTACH][Status] %s died. No new target available."):format(A(aL)))aM()end end end)end;local function aV()for N,aW in ipairs({r._hoverAP,r._hoverAO,r._hoverA0,r._hoverA1})do if aW then pcall(function()aW:Destroy()end)end end;r._hoverAP,r._hoverAO,r._hoverA0,r._hoverA1=nil,nil,nil,nil end;function startHover()if r._hb then pcall(function()r._hb:Disconnect()end)r._hb=nil end;aV()r._phase="Hover"local aR,aL,aX=d.humanoidRootPart,r.currentInst,nil;aX=x(aL)if not(aR and aX and s(aL))then aM()return end;if d.humanoid then d.humanoid.AutoRotate=false end;aR.AssemblyAngularVelocity=Vector3.zero;local aY=Instance.new("Attachment")aY.Name=i.."HoverA0"aY.Parent=aR;local aZ=Instance.new("Attachment")aZ.Name=i.."HoverA1"aZ.Parent=aX;local a_=Instance.new("AlignPosition")a_.Name=i.."HoverAP"a_.Mode=Enum.PositionAlignmentMode.TwoAttachment;a_.Attachment0=aY;a_.Attachment1=aZ;a_.Responsiveness=p.moveForceResp or 80;a_.MaxVelocity=p.moveMaxVelocity or 120;a_.MaxForce=math.huge;a_.Parent=aR;local b0=Instance.new("AlignOrientation")b0.Name=i.."HoverAO"b0.Attachment0=aY;b0.Responsiveness=p.orientResp or 120;b0.MaxTorque=math.huge;b0.RigidityEnabled=true;b0.Parent=aR;r._hoverAP,r._hoverAO,r._hoverA0,r._hoverA1=a_,b0,aY,aZ;local function b1()local b2=x(r.currentInst)if not b2 then return end;if not r._dodgeActive then ah(r.currentInst)end;local C=b2.CFrame;local b3=B(C,r.mode,r.horizDist,r.yOffset)aZ.Position=C:VectorToObjectSpace(b3)end;local function b4()local b5,b6,b2=r.currentInst,d.humanoidRootPart,x(r.currentInst)if not(b5 and s(b5)and b6 and b2)then aM()return end;local b7,b8=b6.Position,b2.Position;local b9=b8-b7;if b9.Magnitude<1e-6 then return end;b9=b9.Unit;local I=math.abs(b9:Dot(Vector3.yAxis))>0.98 and Vector3.xAxis or Vector3.yAxis;local ba=CFrame.lookAt(b7,b8,I)*CFrame.Angles(0,math.pi,0)r._hoverAO.CFrame=ba end;b1()b4()r._hb=b.RunService.RenderStepped:Connect(function()if not r.attached then return end;b1()b4()end)end;local function bb()if r._hb then pcall(function()r._hb:Disconnect()end)r._hb=nil end;aV()if d.humanoid then d.humanoid.AutoRotate=true end;r._phase="Idle"end;local function bc()if r._watchSelf then r._watchSelf:Disconnect()r._watchSelf=nil end end;local function bd()bc()r._watchSelf=b.Players.LocalPlayer.CharacterAdded:Connect(function()task.wait(0.2)if r.attached then bb()startApproach()end end)end;local be=c.Main:AddRightGroupbox(o.groupTitle or"Attach","link")local bf,bg;local function bh(bi)local Z=V(r.targetType)local bj={}for bk,bl in pairs(Z)do if bl and#bl>0 then bj[#bj+1]=bk end end;table.sort(bj)bi:SetValues(bj)end;do local bm={}for bn,N in pairs(m)do bm[#bm+1]=bn end;table.sort(bm)bg=be:AddDropdown("ATT_Type",{Text="Target Type",Values=bm,Default=n.targetType or bm[1],Callback=function(aW)r.targetType=aW;r.selectedTargets={}bh(bf)end})end;bf=be:AddDropdown("ATT_Target",{Text="Target",Values={},Multi=true,Callback=function(aW)local _={}for a0,bo in pairs(aW)do if bo then _[#_+1]=a0 end end;r.selectedTargets=_;if r.attached then local aG=a7()if aG then r.currentInst=aG;startApproach()else aM()end end end})be:AddButton({Text="Refresh Targets",Func=function()bh(bf)end})be:AddDropdown("ATT_Mode",{Text="Attach Mode",Values={"Behind","In Front","Left","Right","Aligned"},Default=n.mode or"Behind",Callback=function(aW)r.mode=aW;if r.attached then startApproach()end end})be:AddSlider("ATT_Y",{Text="Y Offset",Default=n.yOffset or 10,Min=-30,Max=30,Suffix=" studs",Callback=function(aW)r.yOffset=aW;if r.attached then startApproach()end end})be:AddToggle("ATT_On",{Text="Attach",Default=false,Callback=function(bo)r.attached=bo;if bo then local a6=a7()r.currentInst=a6;if not a6 then aM()return end;startApproach()bd()if r.showStatus then aH()end else bb()bc()aD()end end})be:AddToggle("ATT_Dodge",{Text="Dodge Mode",Default=n.dodgeMode or false,Callback=function(aW)r.dodgeMode=aW;if r.currentInst then ad(r.currentInst)end end})be:AddToggle("ATT_AutoY",{Text="AutoSet Y Offset",Default=n.autoYOffset or false,Callback=function(aW)r.autoYOffset=aW end})be:AddToggle("ATT_Status",{Text="Show Status",Default=n.showStatus or false,Tooltip="On-screen target + HP HUD. Only prints for deaths and retargets.",Callback=function(bo)r.showStatus=bo;if bo then aH()else aD()end end})bh(bf)local bp={}function bp.Unload()bb()aj()aD()bc()if g and g.ATT_On and g.ATT_On.Value then pcall(function()g.ATT_On:SetValue(false)end)end end;return bp end
