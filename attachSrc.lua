return function(a)local b,c,d,e,f,g=a.Services,a.Tabs,a.References,a.Library,a.Options,a.Toggles;local h=a.LPH_NO_VIRTUALIZE or function(i)return i end;local j,k,l=a.MoveToPos,a.PREFIX or"NH_",a.Config or{}local m=l.DodgeConfig or{}local n=l.AutoYOffsetConfig or{}local o=l.TargetTypes or{Players={key="Players"},Entities={key="Entities"}}local p=l.Defaults or{mode="Aligned",yOffset=10,horizDist=4,targetType="Players"}local q=l.UIText or{groupTitle="Attach",statusTitle="Autofarm Status"}local r=l.Move or{approachMaxSecs=12,reachDistance=3,moveForceResp=80,moveMaxVelocity=120,orientResp=120}local s=l.Perf or{scanCooldown=0.5,waitScanHz=4,statusHz=5}local t={mode=p.mode,yOffset=p.yOffset,horizDist=p.horizDist,targetType=p.targetType,selectedTargets={},currentInst=nil,attached=false,_phase="Idle",_hb=nil,_watchSelf=nil,_moveCleanup=nil,dodgeMode=p.dodgeMode,autoYOffset=p.autoYOffset,_dodgeActive=false,_dodgeConn=nil,showStatus=p.showStatus,_statusHB=nil,_statusDiedConn=nil,_statusLastTarget=nil,_statusLastHealth=nil,_statusGui=nil,_statusBar=nil,_statusText=nil,_hoverAP=nil,_hoverAO=nil,_hoverA0=nil,_hoverA1=nil}local function u(v)if not(v and v.Parent)then return false end;local w=v:FindFirstChildOfClass("Humanoid")if w then return w.Health>0 end;if v:IsA("Player")then local x=v.Character;local y=x and x:FindFirstChildOfClass("Humanoid")return x and y and y.Health>0 or false end;return(v:FindFirstChild("HumanoidRootPart")or v:FindFirstChildWhichIsA("BasePart"))~=nil end;local function z(A)if not A then return end;if A:IsA("Player")then local x=A.Character;return x and x:FindFirstChild("HumanoidRootPart")end;return A:FindFirstChild("HumanoidRootPart")or A:FindFirstChildWhichIsA("BasePart")end;local function B(A)if not A then return end;if A:IsA("Player")then local x=A.Character;return x and x:FindFirstChildOfClass("Humanoid")end;if A:IsA("Model")then return A:FindFirstChildOfClass("Humanoid")end end;local function C(v)if not v then return"nil"end;if v:IsA("Player")then return v.DisplayName~=""and v.DisplayName or v.Name end;return v.Name end;local function D(E,F,G,H)local i,I=E.LookVector,E.RightVector;local J=Vector3.new(0,H,0)if F=="Behind"then return-i*G+J elseif F=="In Front"then return i*G+J elseif F=="Left"then return-I*G+J elseif F=="Right"then return I*G+J else return J end end;local K={Players={t=0,res=nil},Entities={t=0,res=nil}}local L=tonumber(s.scanCooldown)or 0.5;local function M()local N={}for O,P in ipairs(b.Players:GetPlayers())do if P~=d.player then N[P.DisplayName~=""and P.DisplayName or P.Name]={P}end end;return N end;local function Q()local N={}for O,R in ipairs(b.Workspace:GetDescendants())do if R:IsA("Model")and not b.Players:GetPlayerFromCharacter(R)then local w=R:FindFirstChildOfClass("Humanoid")if w then N[R.Name]=N[R.Name]or{}table.insert(N[R.Name],R)end end end;return N end;local function S(T)local U=os.clock()if T=="Players"then local V=K.Players;if U-V.t>=L or not V.res then V.res=M()V.t=U end;return V.res elseif T=="Entities"then local V=K.Entities;if U-V.t>=L or not V.res then V.res=Q()V.t=U end;return V.res end;return{}end;local function W(X)local Y=o[X]if not Y then return{}end;return S(Y.key or X)end;local function Z()local _=W(t.targetType)local a0={}for O,a1 in ipairs(t.selectedTargets or{})do local a2=_[a1]if a2 then for O,v in ipairs(a2)do if u(v)then a0[#a0+1]=v end end end end;return a0 end;local function a3(a2)local a4=d.humanoidRootPart;if not a4 or not a2 or#a2==0 then return end;local a5,a6;for O,v in ipairs(a2)do local a7=z(v)if a7 then local R=(a7.Position-a4.Position).Magnitude;if not a6 or R<a6 then a5,a6=v,R end end end;return a5 end;local function a8()return a3(Z())end;local function a9()if t._dodgeActive then t._dodgeActive=false end end;local function aa(ab,ac)if t._dodgeActive then return end;t._dodgeActive=true;local ad=t.yOffset;t.yOffset=ab;task.delay(ac,function()if t._dodgeActive then t.yOffset=ad;a9()end end)end;local function ae(A)if t._dodgeConn then t._dodgeConn:Disconnect()end;if not(t.dodgeMode and A)then return end;local w=A:FindFirstChildOfClass("Humanoid")if not w then return end;t._dodgeConn=w.AnimationPlayed:Connect(function(af)local ag=tonumber((af.Animation.AnimationId or""):match("%d+"))local ah=ag and m[ag]if ah then task.delay(ah.delay,function()aa(ah.dodgeY,ah.duration)end)end end)end;local function ai(A)if t._dodgeActive then return end;if not(t.autoYOffset and A)then return end;for a1,aj in pairs(n)do if A.Name:find(a1)then t.yOffset=aj;return end end end;local function ak()if t._hb then pcall(function()t._hb:Disconnect()end)t._hb=nil end;if t._moveCleanup then pcall(t._moveCleanup)t._moveCleanup=nil end;t._phase="Idle"end;local function al()if t._moveCleanup then pcall(t._moveCleanup)t._moveCleanup=nil end end;local function am()if t._statusGui then pcall(function()t._statusGui:Destroy()end)end;t._statusGui,t._statusBar,t._statusText=nil,nil,nil end;local function an()if t._statusGui and t._statusGui.Parent then return end;local ao=b.Players.LocalPlayer:FindFirstChildOfClass("PlayerGui")if not ao then return end;local ap=Instance.new("ScreenGui")ap.Name=k.."AttachStatus"ap.ResetOnSpawn=false;ap.ZIndexBehavior=Enum.ZIndexBehavior.Sibling;ap.Parent=ao;local aq=Instance.new("Frame")aq.Name="Panel"aq.AnchorPoint=Vector2.new(0,0)aq.Position=UDim2.fromOffset(12,100)aq.Size=UDim2.fromOffset(240,62)aq.BackgroundColor3=Color3.fromRGB(18,18,18)aq.BackgroundTransparency=0.2;aq.BorderSizePixel=0;aq.Parent=ap;local ar=Instance.new("UICorner")ar.CornerRadius=UDim.new(0,10)ar.Parent=aq;local as=Instance.new("TextLabel")as.Name="Title"as.Size=UDim2.new(1,-10,0,22)as.Position=UDim2.fromOffset(8,6)as.BackgroundTransparency=1;as.Font=Enum.Font.GothamSemibold;as.TextSize=14;as.TextXAlignment=Enum.TextXAlignment.Left;as.TextColor3=Color3.fromRGB(200,255,200)as.Text=q.statusTitle or"Autofarm Status"as.Parent=aq;local at=Instance.new("TextLabel")at.Name="HPText"at.Size=UDim2.new(1,-10,0,18)at.Position=UDim2.fromOffset(8,28)at.BackgroundTransparency=1;at.Font=Enum.Font.Gotham;at.TextSize=13;at.TextXAlignment=Enum.TextXAlignment.Left;at.TextColor3=Color3.fromRGB(230,230,230)at.Text="Target: —  HP: —/—"at.Parent=aq;local au=Instance.new("Frame")au.Name="BarBG"au.Size=UDim2.fromOffset(224,8)au.Position=UDim2.fromOffset(8,48)au.BackgroundColor3=Color3.fromRGB(45,45,45)au.BorderSizePixel=0;au.Parent=aq;local av=Instance.new("UICorner")av.CornerRadius=UDim.new(0,4)av.Parent=au;local aw=Instance.new("Frame")aw.Name="Bar"aw.Size=UDim2.new(0,0,1,0)aw.BackgroundColor3=Color3.fromRGB(50,205,50)aw.BorderSizePixel=0;aw.Parent=au;local ax=Instance.new("UICorner")ax.CornerRadius=UDim.new(0,4)ax.Parent=aw;t._statusGui,t._statusBar,t._statusText=ap,aw,at end;local function ay(A,az,aA)if not(t._statusGui and t._statusGui.Parent)then return end;local a7,aB=t._statusText,t._statusBar;if not(a7 and aB)then return end;local y,aC=tonumber(az)or 0,tonumber(aA)or 0;local aD=aC>0 and math.clamp(y/aC,0,1)or 0;a7.Text=("Target: %s    HP: %d/%d"):format(A and C(A)or"—",y,aC)aB.Size=UDim2.new(aD,0,1,0)end;local function aE()if t._statusHB then pcall(function()t._statusHB:Disconnect()end)t._statusHB=nil end;if t._statusDiedConn then pcall(function()t._statusDiedConn:Disconnect()end)t._statusDiedConn=nil end;t._statusLastTarget,t._statusLastHealth=nil,nil;am()end;local function aF(A)if t._statusDiedConn then pcall(function()t._statusDiedConn:Disconnect()end)t._statusDiedConn=nil end;local w=B(A)if w then t._statusDiedConn=w.Died:Connect(function()local aG=C(A)local aH=a8()if aH and aH~=A then t.currentInst=aH;print(("[ATTACH][Status] %s died. New target → %s"):format(aG,C(aH)))if t._phase~="Approach"and t.attached then startApproach()end else print(("[ATTACH][Status] %s died. No new target available."):format(aG))end end)end end;local function aI()aE()if not t.showStatus then return end;an()local aJ,aK=0,1/math.max(1,tonumber(s.statusHz)or 5)t._statusHB=b.RunService.Heartbeat:Connect(h(function(aL)if not t.showStatus then return end;aJ=aJ+aL;if aJ<aK then return end;aJ=0;local aM=t.currentInst;if aM~=t._statusLastTarget then if t._statusLastTarget and aM then print(("[ATTACH][Status] Target switch: %s → %s"):format(C(t._statusLastTarget),C(aM)))end;t._statusLastTarget,t._statusLastHealth=aM,nil;if aM then aF(aM)end end;if not aM then ay(nil,0,0)return end;local w=B(aM)if w then local az,aC=math.floor(w.Health),math.floor(w.MaxHealth or 0)if az~=t._statusLastHealth then t._statusLastHealth=az;ay(aM,az,aC)end else ay(aM,0,0)end end))end;local function aN()ak()t._phase="Waiting"local aJ,aK=0,1/math.max(1,tonumber(s.waitScanHz)or 4)t._hb=b.RunService.Heartbeat:Connect(h(function(aL)if not t.attached then return end;if not(t.selectedTargets and#t.selectedTargets>0)then return end;aJ=aJ+aL;if aJ<aK then return end;aJ=0;local aH=a8()if aH then t.currentInst=aH;startApproach()end end))end;function startApproach()ak()t._phase="Approach"local aM=t.currentInst;if not aM then local aO=a8()if not aO then aN()return end;aM=aO;t.currentInst=aO end;ai(aM)ae(aM)if t.showStatus then aI()end;local function aP()if not u(aM)then return nil end;local a7=z(aM)if not a7 then return nil end;return a7.Position+D(a7.CFrame,t.mode,t.horizDist,t.yOffset)end;local aQ=aP()if not aQ then aN()return end;t._moveCleanup=j(aQ,1000,aP)local aR=os.clock()t._hb=b.RunService.Heartbeat:Connect(h(function()if t._phase~="Approach"then return end;local aS=d.humanoidRootPart;if not aS then ak()return end;local aT=aP()if not aT then aN()return end;if(aS.Position-aT).Magnitude<=(r.reachDistance or 3)then al()t._phase="Hover"task.defer(function()if t.attached then task.wait(0.05)startHover()end end)return end;if os.clock()-aR>(r.approachMaxSecs or 12)then aN()return end;if not u(aM)then local aH=a8()if aH then local aU=aM;t.currentInst,aM=aH,aH;print(("[ATTACH][Status] %s died. New target → %s"):format(C(aU),C(aH)))if t.showStatus then aI()end;ai(aM)ae(aM)local aV=aP()if aV then al()t._moveCleanup=j(aV,1000,aP)aR=os.clock()else aN()end else print(("[ATTACH][Status] %s died. No new target available."):format(C(aM)))aN()end end end))end;local function aW()for O,aX in ipairs({t._hoverAP,t._hoverAO,t._hoverA0,t._hoverA1})do if aX then pcall(function()aX:Destroy()end)end end;t._hoverAP,t._hoverAO,t._hoverA0,t._hoverA1=nil,nil,nil,nil end;function startHover()if t._hb then pcall(function()t._hb:Disconnect()end)t._hb=nil end;aW()t._phase="Hover"local aS,aM,aY=d.humanoidRootPart,t.currentInst,nil;aY=z(aM)if not(aS and aY and u(aM))then aN()return end;if d.humanoid then d.humanoid.AutoRotate=false end;aS.AssemblyAngularVelocity=Vector3.zero;local aZ=Instance.new("Attachment")aZ.Name=k.."HoverA0"aZ.Parent=aS;local a_=Instance.new("Attachment")a_.Name=k.."HoverA1"a_.Parent=aY;local b0=Instance.new("AlignPosition")b0.Name=k.."HoverAP"b0.Mode=Enum.PositionAlignmentMode.TwoAttachment;b0.Attachment0=aZ;b0.Attachment1=a_;b0.Responsiveness=r.moveForceResp or 80;b0.MaxVelocity=r.moveMaxVelocity or 120;b0.MaxForce=math.huge;b0.Parent=aS;local b1=Instance.new("AlignOrientation")b1.Name=k.."HoverAO"b1.Attachment0=aZ;b1.Responsiveness=r.orientResp or 120;b1.MaxTorque=math.huge;b1.RigidityEnabled=true;b1.Parent=aS;t._hoverAP,t._hoverAO,t._hoverA0,t._hoverA1=b0,b1,aZ,a_;local function b2()local b3=z(t.currentInst)if not b3 then return end;if not t._dodgeActive then ai(t.currentInst)end;local E=b3.CFrame;local b4=D(E,t.mode,t.horizDist,t.yOffset)a_.Position=E:VectorToObjectSpace(b4)end;local function b5()local b6,b7,b3=t.currentInst,d.humanoidRootPart,z(t.currentInst)if not(b6 and u(b6)and b7 and b3)then aN()return end;local b8,b9=b7.Position,b3.Position;local ba=b9-b8;if ba.Magnitude<1e-6 then return end;ba=ba.Unit;local J=math.abs(ba:Dot(Vector3.yAxis))>0.98 and Vector3.xAxis or Vector3.yAxis;local bb=CFrame.lookAt(b8,b9,J)*CFrame.Angles(0,math.pi,0)t._hoverAO.CFrame=bb end;b2()b5()t._hb=b.RunService.RenderStepped:Connect(h(function()if not t.attached then return end;b2()b5()end))end;local function bc()if t._hb then pcall(function()t._hb:Disconnect()end)t._hb=nil end;aW()if d.humanoid then d.humanoid.AutoRotate=true end;t._phase="Idle"end;local function bd()if t._watchSelf then t._watchSelf:Disconnect()t._watchSelf=nil end end;local function be()bd()t._watchSelf=b.Players.LocalPlayer.CharacterAdded:Connect(h(function()task.wait(0.2)if t.attached then bc()startApproach()end end))end;local bf=c.Main:AddRightGroupbox(q.groupTitle or"Attach","link")local bg,bh;local function bi(bj)local _=W(t.targetType)local bk={}for bl,bm in pairs(_)do if bm and#bm>0 then bk[#bk+1]=bl end end;table.sort(bk)bj:SetValues(bk)end;do local bn={}for bo,O in pairs(o)do bn[#bn+1]=bo end;table.sort(bn)bh=bf:AddDropdown("ATT_Type",{Text="Target Type",Values=bn,Default=p.targetType or bn[1],Callback=function(aX)t.targetType=aX;t.selectedTargets={}bi(bg)end})end;bg=bf:AddDropdown("ATT_Target",{Text="Target",Values={},Multi=true,Callback=function(aX)local a0={}for a1,bp in pairs(aX)do if bp then a0[#a0+1]=a1 end end;t.selectedTargets=a0;if t.attached then local aH=a8()if aH then t.currentInst=aH;startApproach()else aN()end end end})bf:AddButton({Text="Refresh Targets",Func=function()bi(bg)end})bf:AddDropdown("ATT_Mode",{Text="Attach Mode",Values={"Behind","In Front","Left","Right","Aligned"},Default=p.mode or"Behind",Callback=function(aX)t.mode=aX;if t.attached then startApproach()end end})bf:AddSlider("ATT_Y",{Text="Y Offset",Default=p.yOffset or 10,Min=-30,Max=30,Suffix=" studs",Callback=function(aX)t.yOffset=aX;if t.attached then startApproach()end end})bf:AddToggle("ATT_On",{Text="Attach",Default=false,Callback=function(bp)t.attached=bp;if bp then local a7=a8()t.currentInst=a7;if not a7 then aN()return end;startApproach()be()if t.showStatus then aI()end else bc()bd()aE()end end})bf:AddToggle("ATT_Dodge",{Text="Dodge Mode",Default=p.dodgeMode or false,Callback=function(aX)t.dodgeMode=aX;if t.currentInst then ae(t.currentInst)end end})bf:AddToggle("ATT_AutoY",{Text="AutoSet Y Offset",Default=p.autoYOffset or false,Callback=function(aX)t.autoYOffset=aX end})bf:AddToggle("ATT_Status",{Text="Show Status",Default=p.showStatus or false,Tooltip="On-screen target + HP HUD. Only prints for deaths and retargets.",Callback=function(bp)t.showStatus=bp;if bp then aI()else aE()end end})bi(bg)local bq={}function bq.Unload()bc()ak()aE()bd()if g and g.ATT_On and g.ATT_On.Value then pcall(function()g.ATT_On:SetValue(false)end)end end;return bq end
