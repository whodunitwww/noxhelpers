return function(a)local b=a.Services;local c=a.Tabs;local d=a.References;local e=a.Library;local f=a.Options;local g=a.Toggles;local h=a.MoveToPos;local i=a.PREFIX or"NH_"local j=a.Config or{}local k=j.Defaults or{}local l=j.UIText or{}local m=j.Move or{}local n=j.DodgeConfig or{}local o=j.AutoYOffsetConfig or{}local p=j.TargetTypes or{Players={key="Players"},Entities={key="Entities"}}local function q(r,s)if e and e.Notify then e:Notify(r,s or 2)end end;local function t(u)if not u then return nil end;if u:IsA("Player")then local v=u.Character;if not v then return nil end;return v:FindFirstChild("HumanoidRootPart")or v:FindFirstChildWhichIsA("BasePart")end;if u:IsA("Model")then return u:FindFirstChild("HumanoidRootPart")or u:FindFirstChildWhichIsA("BasePart")end;if u:IsA("BasePart")then return u end;return nil end;local function w(u)if not u then return nil end;if u:IsA("Player")then local v=u.Character;return v and v:FindFirstChildOfClass("Humanoid")end;if u:IsA("Model")then return u:FindFirstChildOfClass("Humanoid")end;return nil end;local function x(u)if not(u and u.Parent)then return false end;local y=w(u)if y then return y.Health>0 end;return true end;local function z(u)return u and u.Parent and x(u)and t(u)~=nil end;local function A(B)if not B then return"nil"end;if B:IsA("Player")then return B.DisplayName~=""and B.DisplayName or B.Name end;return B.Name end;local function C(D,E,F,G)local H=D.LookVector;local I=D.RightVector;local J=Vector3.new(0,G,0)if E=="Behind"then return-H*F+J elseif E=="In Front"then return H*F+J elseif E=="Left"then return-I*F+J elseif E=="Right"then return I*F+J else return J end end;local function K()local L={}for M,N in ipairs(b.Players:GetPlayers())do if N~=d.player then local O=N.DisplayName~=""and N.DisplayName or N.Name;L[O]=L[O]or{}table.insert(L[O],N)end end;return L end;local function P()local L={}for M,Q in ipairs(b.Workspace:GetDescendants())do if Q:IsA("Model")and not b.Players:GetPlayerFromCharacter(Q)then local y=Q:FindFirstChildOfClass("Humanoid")if y then local O=Q.Name;L[O]=L[O]or{}table.insert(L[O],Q)end end end;return L end;local function R(S)local T=b.Workspace;for U in string.gmatch(S or"","[^/]+")do T=T and T:FindFirstChild(U)end;local L={}if not T then return L end;for M,Q in ipairs(T:GetDescendants())do if Q:IsA("Model")then local y=Q:FindFirstChildOfClass("Humanoid")if y then local O=Q.Name;L[O]=L[O]or{}table.insert(L[O],Q)end end end;return L end;local function V(W)local L={}if type(W.static)~="table"then return L end;local X=b.Workspace;for M,O in ipairs(W.static)do local Y={}for M,B in ipairs(X:GetDescendants())do if B:IsA("Model")and B.Name==O then table.insert(Y,B)end end;if#Y>0 then L[O]=Y end end;return L end;local function Z(_)local W=p[_]if not W then return{}end;if W.staticOnly then return V(W)end;if W.getItems then local a0,a1=pcall(W.getItems,b,d)return a0 and(a1 or{})or{}end;if W.folderPath then return R(W.folderPath)end;if W.key=="Players"then return K()end;if W.key=="Entities"then return P()end;return{}end;local a2={running=false,stage="Idle",targetType=k.targetType or"Players",selectedNames={},currentTarget=nil,mode=k.mode or"Aligned",yOffset=k.yOffset or 10,horizDist=k.horizDist or 4,movement=k.movement or"Approach",autoYOffset=k.autoYOffset or false,dodgeMode=k.dodgeMode or false,dodgeRange=k.dodgeRange or 50,_hb=nil,_moveCleanup=nil,_attachA0=nil,_attachA1=nil,_alignPos=nil,_alignOri=nil,_noclipHB=nil,_dodgeActive=false,_humConns={},_humAdded=nil,_humRemoved=nil}local function a3(u)if not(a2.autoYOffset and u and o)then return end;if a2._dodgeActive then return end;local a4=A(u)for _,a5 in pairs(o)do if tostring(a4):find(_,1,true)then if type(a5)=="number"then a2.yOffset=a5 elseif type(a5)=="table"then if a5.y~=nil then a2.yOffset=tonumber(a5.y)or a2.yOffset end;if a5.mode and type(a5.mode)=="string"then a2.mode=a5.mode end;if a5.horiz~=nil then a2.horizDist=tonumber(a5.horiz)or a2.horizDist elseif a5.horizDist~=nil then a2.horizDist=tonumber(a5.horizDist)or a2.horizDist end end;break end end end;local function a6()local L=Z(a2.targetType)local a7={}for M,O in ipairs(a2.selectedNames)do local Y=L[O]if Y then for M,B in ipairs(Y)do if z(B)then a7[#a7+1]=B end end end end;return a7 end;local function a8()local a9=d.humanoidRootPart;if not a9 then return nil end;local aa=a6()local ab,ac;for M,B in ipairs(aa)do local ad=t(B)if ad then local ae=(ad.Position-a9.Position).Magnitude;if not ac or ae<ac then ac=ae;ab=B end end end;return ab end;local function af()local ag=d.character;if not ag then return end;for M,Q in ipairs(ag:GetDescendants())do if Q:IsA("BasePart")then Q.CanCollide=false end end end;local function ah()if a2._noclipHB then return end;a2._noclipHB=b.RunService.Stepped:Connect(af)end;local function ai()if a2._noclipHB then a2._noclipHB:Disconnect()a2._noclipHB=nil end end;local function aj()if a2._alignPos then pcall(function()a2._alignPos:Destroy()end)end;if a2._alignOri then pcall(function()a2._alignOri:Destroy()end)end;if a2._attachA0 then pcall(function()a2._attachA0:Destroy()end)end;if a2._attachA1 then pcall(function()a2._attachA1:Destroy()end)end;a2._alignPos,a2._alignOri=nil,nil;a2._attachA0,a2._attachA1=nil,nil;ai()if d.humanoid then d.humanoid.AutoRotate=true end end;local function ak(u)aj()local a9=d.humanoidRootPart;local al=t(u)if not(a9 and al)then return end;if d.humanoid then d.humanoid.AutoRotate=false end;a9.AssemblyAngularVelocity=Vector3.zero;local am=Instance.new("Attachment")am.Name=i.."ATT_A0"am.Parent=a9;local an=Instance.new("Attachment")an.Name=i.."ATT_A1"an.Parent=al;local ao=Instance.new("AlignPosition")ao.Name=i.."ATT_AP"ao.Mode=Enum.PositionAlignmentMode.TwoAttachment;ao.Attachment0=am;ao.Attachment1=an;ao.Responsiveness=m.moveForceResp or 80;ao.MaxVelocity=m.moveMaxVelocity or 120;ao.MaxForce=math.huge;ao.Parent=a9;local ap=Instance.new("AlignOrientation")ap.Name=i.."ATT_AO"ap.Mode=Enum.OrientationAlignmentMode.OneAttachment;ap.Attachment0=am;ap.Responsiveness=m.orientResp or 120;ap.MaxTorque=math.huge;ap.RigidityEnabled=true;ap.Parent=a9;a2._attachA0=am;a2._attachA1=an;a2._alignPos=ao;a2._alignOri=ap;ah()end;local function aq()for y,ar in pairs(a2._humConns)do if ar then pcall(function()ar:Disconnect()end)end;a2._humConns[y]=nil end;if a2._humAdded then a2._humAdded:Disconnect()a2._humAdded=nil end;if a2._humRemoved then a2._humRemoved:Disconnect()a2._humRemoved=nil end;a2._dodgeActive=false end;local function as(at,s)if a2._dodgeActive then return end;a2._dodgeActive=true;local au=a2.yOffset;a2.yOffset=at;task.delay(s,function()if a2._dodgeActive then a2.yOffset=au;a2._dodgeActive=false end end)end;local function av(B)local a9=d.humanoidRootPart;local al=t(B)if not(a9 and al)then return false end;return(al.Position-a9.Position).Magnitude<=(a2.dodgeRange or 50)end;local function aw(y)if not y or a2._humConns[y]then return end;local ax=b.Players:GetPlayerFromCharacter(y.Parent)~=nil;if ax then return end;a2._humConns[y]=y.AnimationPlayed:Connect(function(ay)local az=ay and ay.Animation;local aA=az and az.AnimationId or""local aB=tonumber(string.match(aA,"%d+"))if not aB then return end;local aC=n[aB]if not aC then return end;if not av(y.Parent)then return end;local aD=tonumber(aC.delay)or 0;local aE=tonumber(aC.dodgeY)or a2.yOffset;local aF=tonumber(aC.duration)or 0.5;task.delay(aD,function()if a2.dodgeMode and av(y.Parent)then as(aE,aF)end end)end)end;local function aG()aq()if not a2.dodgeMode then return end;for M,Q in ipairs(b.Workspace:GetDescendants())do if Q:IsA("Humanoid")then aw(Q)end end;a2._humAdded=b.Workspace.DescendantAdded:Connect(function(Q)if a2.dodgeMode and Q:IsA("Humanoid")then aw(Q)end end)a2._humRemoved=b.Workspace.DescendantRemoving:Connect(function(Q)if Q:IsA("Humanoid")then local aH=a2._humConns[Q]if aH then pcall(function()aH:Disconnect()end)end;a2._humConns[Q]=nil end end)end;local function aI()if a2._hb then a2._hb:Disconnect()a2._hb=nil end end;local function aJ()if a2._moveCleanup then pcall(a2._moveCleanup)a2._moveCleanup=nil end end;local function aK(u)local a9=d.humanoidRootPart;local al=t(u)if not(a9 and al)then return false end;local aL=al.Position+C(al.CFrame,a2.mode,a2.horizDist,a2.yOffset)a9.CFrame=CFrame.new(aL,al.Position)return true end;local function aM()aJ()aI()local aN=a2.currentTarget;if not z(aN)then a2.currentTarget=nil;a2.stage="Idle"aj()return end;a2.stage="Attach"ak(aN)a2._hb=b.RunService.RenderStepped:Connect(function()if not a2.running then return end;local a9=d.humanoidRootPart;local al=t(a2.currentTarget)if not(a9 and al and z(a2.currentTarget))then local aO=a8()if aO then a2.currentTarget=aO;a3(aO)aM()else a2.currentTarget=nil;a2.stage="Idle"aj()aI()end;return end;if not a2._dodgeActive then a3(a2.currentTarget)end;if a2._attachA1 then local D=al.CFrame;local aP=C(D,a2.mode,a2.horizDist,a2.yOffset)a2._attachA1.Position=D:VectorToObjectSpace(aP)end;if a2._alignOri then local aQ=a9.Position;local aR=al.Position;local aS=aR-aQ;local aT=aS.Magnitude;if aT>1e-4 then aS=aS/aT;local J=Vector3.yAxis;if math.abs(aS:Dot(J))>0.98 then J=Vector3.xAxis end;a2._alignOri.CFrame=CFrame.lookAt(aQ,aR,J)end end end)end;local function aU()aJ()aI()aj()local u=a2.currentTarget;if not z(u)then a2.currentTarget=a8()u=a2.currentTarget;if not u then a2.stage="Idle"q("No valid targets to attach.",2)return end end;a2.stage="Approach"a3(u)if string.lower(tostring(a2.movement))=="teleport"then if aK(u)then aM()else q("Teleport failed (no HRP/target).",2)a2.stage="Idle"end;return end;local function aV()local a9=d.humanoidRootPart;local al=t(u)if not(a9 and al and z(u))then return nil end;return al.Position+C(al.CFrame,a2.mode,a2.horizDist,a2.yOffset)end;local aW=aV()if not aW then q("Failed to compute approach position.",2)a2.stage="Idle"return end;a2._moveCleanup=h(aW,tonumber(m.approachSpeed)or 1000,function()return aV()end)local aX=os.clock()local aY=m.approachMaxSecs or 12;local aZ=m.reachDistance or 3;a2._hb=b.RunService.Heartbeat:Connect(function()if not a2.running then return end;local a9=d.humanoidRootPart;local a_=aV()if not(a9 and a_ and z(u))then local aO=a8()if aO then a2.currentTarget=aO;u=aO;a3(aO)else a2.currentTarget=nil;a2.stage="Idle"aJ()aI()end;return end;if(a9.Position-a_).Magnitude<=aZ then aM()return end;if os.clock()-aX>aY then q("Attach approach timeout.",2)a2.stage="Idle"aJ()aI()end end)end;local b0=c and(c["Auto"]or c.AddTab and c:AddTab("Auto"))if not b0 then error("Attach engine: missing Auto tab")end;local b1=l.groupTitle or"Attach"local b2=b0:AddRightGroupbox(b1,"link")local b3;local b4;local function b5()if not b4 then return end;local W=p[a2.targetType]or{}local L=Z(a2.targetType)local b6={}if type(W.static)=="table"then for M,O in ipairs(W.static)do b6[O]=true end end;for O,Y in pairs(L)do if Y and#Y>0 then b6[O]=true end end;local b7={}for O,M in pairs(b6)do table.insert(b7,O)end;table.sort(b7)b4:SetValues(b7)end;do local b8={}for b9 in pairs(p)do table.insert(b8,b9)end;table.sort(b8)b3=b2:AddDropdown("ATT_Type",{Text="Target Type",Values=b8,Default=a2.targetType,Callback=function(a5)a2.targetType=a5;a2.selectedNames={}b5()end})end;b4=b2:AddDropdown("ATT_Targets",{Text="Targets",Values={},Multi=true,Callback=function(ba)local bb={}for O,bc in pairs(ba)do if bc then bb[#bb+1]=O end end;a2.selectedNames=bb;if a2.running then a2.currentTarget=a8()if a2.currentTarget then aU()else q("No targets selected / visible.",2)end end end})b2:AddButton({Text="Refresh Targets",Func=b5})b2:AddDropdown("ATT_Mode",{Text="Attach Mode",Values={"Behind","In Front","Left","Right","Aligned"},Default=a2.mode,Callback=function(a5)a2.mode=a5 end})b2:AddSlider("ATT_YOffset",{Text="Y Offset",Min=-30,Max=40,Default=a2.yOffset,Suffix=" studs",Callback=function(a5)a2.yOffset=a5 end})b2:AddSlider("ATT_Horiz",{Text="Horizontal Distance",Min=0,Max=20,Default=a2.horizDist,Suffix=" studs",Callback=function(a5)a2.horizDist=a5 end})b2:AddToggle("ATT_AutoY",{Text="Auto Y / Dist",Default=a2.autoYOffset,Callback=function(bc)a2.autoYOffset=bc end})b2:AddToggle("ATT_Dodge",{Text="Dodge Mode",Default=a2.dodgeMode,Callback=function(bc)a2.dodgeMode=bc;if bc then aG()else aq()end end})b2:AddSlider("ATT_DodgeRange",{Text="Dodge Range",Min=10,Max=200,Default=a2.dodgeRange,Suffix=" studs",Callback=function(a5)a2.dodgeRange=a5 end})b2:AddToggle("ATT_On",{Text="Attach",Default=false,Callback=function(bc)if bc then if not d.humanoidRootPart then q("No HumanoidRootPart; cannot attach.",3)if g.ATT_On then g.ATT_On:SetValue(false)end;return end;a2.running=true;aG()a2.currentTarget=a8()if a2.currentTarget then aU()else q("No targets selected / visible.",2)end else a2.running=false;aI()aJ()aj()aq()a2.currentTarget=nil;a2.stage="Idle"end end})b5()local bd={}function bd.HrpOf(u)return t(u)end;function bd.HumOf(u)return w(u)end;function bd.IsAlive(u)return x(u)end;function bd.IsValid(u)return z(u)end;function bd.ComputeOffset(D,E,be,bf)return C(D,E or a2.mode,be or a2.horizDist,bf or a2.yOffset)end;function bd.SetMovement(E)a2.movement=E or a2.movement end;function bd.GetMovement()return a2.movement end;function bd.SetMode(E)a2.mode=E or a2.mode end;function bd.SetYOffset(bf)a2.yOffset=bf or a2.yOffset end;function bd.SetHorizDist(Q)a2.horizDist=Q or a2.horizDist end;function bd.EnableAutoYOffset(bc)a2.autoYOffset=not not bc end;function bd.EnableDodge(bc)a2.dodgeMode=not not bc;if a2.dodgeMode then aG()else aq()end end;function bd.RebuildTargetNames()b5()end;function bd.ChooseNearest()return a8()end;function bd.SetTarget(B)a2.currentTarget=B end;function bd.GetTarget()return a2.currentTarget end;function bd.SetSelectedNames(Y)a2.selectedNames=Y or{}end;function bd.GetSelectedNames()return a2.selectedNames end;function bd.TeleportToTarget(u)return aK(u or a2.currentTarget)end;function bd.CreateAttach(u)ak(u or a2.currentTarget)return a2._alignPos,a2._alignOri end;function bd.DestroyAttach()aj()end;function bd.GoApproach()aU()end;function bd.GoAttach()aM()end;function bd.PerformDodge(at,s)as(at or a2.yOffset+10,s or 0.5)end;function bd.Start()if g.ATT_On then g.ATT_On:SetValue(true)else if not d.humanoidRootPart then q("No HumanoidRootPart; cannot attach.",3)return end;a2.running=true;aG()a2.currentTarget=a8()if a2.currentTarget then aU()else q("No targets selected / visible.",2)end end end;function bd.Stop()if g.ATT_On and g.ATT_On.Value then g.ATT_On:SetValue(false)else a2.running=false;aI()aJ()aj()aq()a2.currentTarget=nil;a2.stage="Idle"end end;function bd.Unload()bd.Stop()end;bd.State=a2;return bd end
